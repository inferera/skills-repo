name: Deploy (GitHub Pages)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For sync detection

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install root deps
        run: npm ci

      - name: Restore skills cache
        uses: actions/cache@v3
        with:
          path: .cache/skills
          key: skills-cache-${{ github.sha }}
          restore-keys: |
            skills-cache-

      - name: Check for upstream changes (optional sync)
        id: sync_check
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for upstream changes..."
          npm run sync:check || true

          if [ -f .sync-result.json ]; then
            CHANGED_COUNT=$(jq '.skills | length' .sync-result.json 2>/dev/null || echo "0")
            if [ "$CHANGED_COUNT" -gt 0 ]; then
              echo "âš ï¸ Found $CHANGED_COUNT skills with upstream changes"
              echo "ðŸ’¡ Tip: Run 'npm run sync' locally or trigger the Sync workflow"
            fi
          fi

      - name: Compute site env
        run: |
          set -euo pipefail
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          OWNER="${GITHUB_REPOSITORY_OWNER}"

          # Default Pages URL differs for user/org pages vs project pages.
          if [[ "${REPO_NAME}" == "${OWNER}.github.io" ]]; then
            DEFAULT_BASE_PATH=""
            DEFAULT_SITE_URL="https://${OWNER}.github.io"
          else
            DEFAULT_BASE_PATH="${REPO_NAME}"
            DEFAULT_SITE_URL="https://${OWNER}.github.io/${REPO_NAME}"
          fi

          # Optional overrides via repo variables:
          # - SITE_URL: full public base URL (no trailing slash preferred)
          # - SITE_BASE_PATH: path segment for GitHub Pages project sites; set to "ROOT" for empty base path
          SITE_URL_VALUE="${SITE_URL:-}"
          SITE_BASE_PATH_VALUE="${SITE_BASE_PATH:-}"
          # NOTE: keep the literal string "ROOT" as a sentinel so next.config.mjs can map it to an empty basePath.
          # If we turn it into an empty string here, the fallback below would overwrite it back to DEFAULT_BASE_PATH.
          if [[ -z "${SITE_BASE_PATH_VALUE}" ]]; then
            SITE_BASE_PATH_VALUE="${DEFAULT_BASE_PATH}"
          fi
          if [[ -z "${SITE_URL_VALUE}" ]]; then
            SITE_URL_VALUE="${DEFAULT_SITE_URL}"
          fi

          echo "SITE_BASE_PATH=${SITE_BASE_PATH_VALUE}" >> "$GITHUB_ENV"
          echo "SITE_URL=${SITE_URL_VALUE}" >> "$GITHUB_ENV"
        env:
          SITE_BASE_PATH: ${{ vars.SITE_BASE_PATH }}
          SITE_URL: ${{ vars.SITE_URL }}

      - name: Build registry artifacts (+ sitemap/robots when SITE_URL is set)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "Building registry with cache-first approach..."
          echo "Cache status: Content from .cache/skills/ will be used if available"
          npm run build:registry

      - name: Install site deps
        run: npm ci --prefix site

      - name: Build site (static export)
        env:
          NEXT_PUBLIC_REPO_SLUG: ${{ github.repository }}
          SITE_URL: ${{ env.SITE_URL }}
          SITE_BASE_PATH: ${{ env.SITE_BASE_PATH }}
        run: npm run build --prefix site

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/out

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
